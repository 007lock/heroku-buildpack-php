#!/usr/bin/env bash
# Build Path: /app/.heroku/php/
# Build Deps: php-5.5.11RC1, libraries/imagemagick

OUT_PREFIX=$1

# fail hard
set -o pipefail
# fail harder
set -eux

# Make the dependencies available.
export PATH=$PWD/bin:$PATH
LD_LIBRARY_PATH=$PWD LIBRARY_PATH=$PWD

echo "=== Bulding PHP ImageMagick Extension for PHP 5.5"

echo "Fetching PHP ImageMagick Extension..."
curl -L http://pecl.php.net/get/imagick-3.1.2.tgz | tar xz
pushd imagick-3.1.2
phpize

echo "Building PHP ImageMagick Extension..."
./configure --prefix=$OUT_PREFIX
make

# Distill the existing PHP installation.
rm -fr ../bin ../etc ../man ../include ../lib ../php ../sbin ../share ../var

make install
popd

echo "Cleanup Up..."
rm -fr imagick-3.1.2 imagick-3.1.2.tgz

echo "Done Building PHP ImageMagick Extension for PHP 5.5!"
